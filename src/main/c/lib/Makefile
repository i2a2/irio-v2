#+======================================================================
# $HeadURL$
# $Id$
#
# Project       : CODAC Core System
#
# Description   : $progName Makefile
#
# Author        : This file was generated by CODAC development toolkit
#
# Copyright (c) : 2010-2023 ITER Organization,
#                 CS 90 046
#                 13067 St. Paul-lez-Durance Cedex
#                 France
#
# This file is part of ITER CODAC software.
# For the terms and conditions of redistribution or use of this software
# refer to the file ITER-LICENSE.TXT located in the top level directory
# of the distribution package.
#
#-======================================================================

#ifdef CODAC_ROOT
#
#else
#
#endif

NIRIO=/usr/

LIBNAME=irioCore

LIBRARIES=NiFpga niflexrio

INCLUDE_DIRS=../include
ifdef CODAC_ROOT
	LIBRARY_DIRS=$(CODAC_ROOT)/lib
	INCLUDE_DIRS+=$(CODAC_ROOT)/include
else
	LIBRARY_DIRS=$(NIRIO)/lib/x86_64-linux-gnu
	INCLUDE_DIRS+=../support
endif

TARGET=../../../../target
LIBRARY_DIR=$(TARGET)/lib
SOURCE_DIR=.
OBJECT_DIR=$(SOURCE_DIR)/.obj
SOURCE_DIR_SUPPORT=../support/

SHAREDLIBRARY=$(LIBRARY_DIR)/lib$(LIBNAME).so
STATICLIBRARY=$(LIBRARY_DIR)/lib$(LIBNAME).a

INCLUDES=$(foreach inc,$(INCLUDE_DIRS),-I$(inc))
LDLIBS=$(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,-rpath,$(libs)) $(foreach libs,$(LIBRARIES),-l$(libs))

# If no support for DMA to GPU, do not compile irioHandlerDMAGPU.c
SOURCES=$(filter-out $(SOURCE_DIR)/irioHandlerDMAGPU.c, $(wildcard $(SOURCE_DIR)/*.c))
OBJECTS=$(addprefix $(OBJECT_DIR)/,$(patsubst %.c,%.o,$(notdir $(SOURCES))))

ifndef CODAC_ROOT
	SOURCES+=$(wildcard ../support/*.c)
endif

ifeq ($(CONFIG_NIRIO_DMA_TO_GPU),1)
	SOURCES+=$(SOURCE_DIR)/irioHandlerDMAGPU.c
endif
	
	
#HFILES=$(wildcard ../include/*.h) $(wildcard ../support/*.h)
#HTARGETS=$(addprefix $(TARGET)/include/, $(HFILES))

C=gcc
CFLAGS=-c -Wall -fPIC
LDFLAGS=-shared

ifdef CODAC_ROOT
	CFLAGS+=-DOPEN_VERSION_NIRIO
else
	CFLAGS+=-DCLOSE_VERSION_NIRIO
endif

ifeq ($(CONFIG_NIRIO_DMA_TO_GPU),1)
	CFLAGS+=-DIRIO_GPU
endif

ifeq ($(COVERAGE),true)
	CFLAGS+= -O0 -g --coverage
	LDFLAGS+= --coverage
endif

.PHONY: all clean run 

all: $(HTARGETS) $(SOURCES) $(SHAREDLIBRARY) $(STATICLIBRARY)

$(TARGET)/include/%.h: %.h
	@mkdir -p $(TARGET)/include
	cp $< $@

clean:
	rm -rf "$(SHAREDLIBRARY)" "$(STATICLIBRARY)" "$(OBJECT_DIR)" $(foreach htarget, $(HTARGETS), "$(htarget)")

run: $(SOURCES) $(SHAREDLIBRARY)
	$(SHAREDLIBRARY)

$(SHAREDLIBRARY): $(OBJECTS)
	mkdir -p $(LIBRARY_DIR)
	$(C) $(LDFLAGS) $(LDLIBS) $(OBJECTS) -o $(SHAREDLIBRARY) 

$(STATICLIBRARY): $(OBJECTS)
	mkdir -p $(LIBRARY_DIR)
	$(AR) rcs $@ $^
	
$(OBJECT_DIR)/%.o: $(SOURCE_DIR_SUPPORT)/%.c
	mkdir -p $(OBJECT_DIR)
	$(C) $(CFLAGS) $(INCLUDES) $< -o $@
	
$(OBJECT_DIR)/%.o: $(SOURCE_DIR)/%.c
	mkdir -p $(OBJECT_DIR)
	$(C) $(CFLAGS) $(INCLUDES) $< -o $@